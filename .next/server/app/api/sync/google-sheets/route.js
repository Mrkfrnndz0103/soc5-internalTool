"use strict";(()=>{var e={};e.id=4138,e.ids=[4138],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},85807:e=>{e.exports=require("module")},55315:e=>{e.exports=require("path")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},6162:e=>{e.exports=require("worker_threads")},8678:e=>{e.exports=import("pg")},92761:e=>{e.exports=require("node:async_hooks")},6005:e=>{e.exports=require("node:crypto")},65714:e=>{e.exports=require("node:diagnostics_channel")},15673:e=>{e.exports=require("node:events")},70612:e=>{e.exports=require("node:os")},49411:e=>{e.exports=require("node:path")},18834:(e,r,t)=>{t.a(e,async(e,o)=>{try{t.r(r),t.d(r,{originalPathname:()=>m,patchFetch:()=>l,requestAsyncStorage:()=>c,routeModule:()=>p,serverHooks:()=>_,staticGenerationAsyncStorage:()=>d});var a=t(49303),n=t(88716),s=t(60670),i=t(21187),u=e([i]);i=(u.then?(await u)():u)[0];let p=new a.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/sync/google-sheets/route",pathname:"/api/sync/google-sheets",filename:"route",bundlePath:"app/api/sync/google-sheets/route"},resolvedPagePath:"C:\\Users\\phlspxuser\\Documents\\Mrkcde\\Ongoing\\soc5-internalTool\\src\\app\\api\\sync\\google-sheets\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:c,staticGenerationAsyncStorage:d,serverHooks:_}=p,m="/api/sync/google-sheets/route";function l(){return(0,s.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:d})}o()}catch(e){o(e)}})},21187:(e,r,t)=>{t.a(e,async(e,o)=>{try{t.r(r),t.d(r,{POST:()=>f});var a=t(87070),n=t(84770),s=t(75748),i=t(11958),u=t(84235),l=t(21067),p=e([s]);s=(p.then?(await p)():p)[0];let y=l.Ry({rows:l.IX(l.Yj()).optional(),headers:l.IX(l.Yj()).optional()}).passthrough(),g={dispatchdate:"dispatch_date",origin:"origin",todeststationname:"to_dest_station_name",tripnumber:"trip_number",tripno:"trip_number",tonumber:"to_number",toparcelquantity:"to_parcel_quantity",loadedtimestamp:"loaded_timestamp",operator:"operator",departuretimestamp:"departure_timestamp",trucksize:"truck_size",vehiclenumber:"vehicle_number",drivername:"driver_name"},E=["row_key","dispatch_date","origin","to_dest_station_name","trip_number","to_number","to_parcel_quantity","loaded_timestamp","operator_raw","operator_ops_id","operator_name","departure_timestamp","truck_size","vehicle_number","driver_name","raw_payload"];function c(e){return null==e?"":String(e).trim()}function d(e){if(!e)return null;let r=e.trim();if(!r)return null;if(/^\d+(\.\d+)?$/.test(r)){let e=Number(r);if(Number.isFinite(e)){let r=new Date((e-25569)*864e5);if(!Number.isNaN(r.getTime()))return r}}let t=new Date(r);return Number.isNaN(t.getTime())?null:t}function _(e){let r={};Object.entries(e).forEach(([e,t])=>{let o=e.toLowerCase().replace(/[^a-z0-9]/g,"");o&&(r[o]=c(t))});let t={};Object.entries(r).forEach(([e,r])=>{let o=g[e];o&&(t[o]=r)});let o=t.trip_number?.toUpperCase();if(!o)return null;let a=t.operator||"",s=null,i=null;if(a){let e=a.match(/\[([^\]]+)\]\s*(.+)/);e?(s=e[1].trim(),i=e[2].trim()||null):i=a}let u=d(t.dispatch_date),l=t.to_number||null,p=function(e){if(!e)return null;let r=e.replace(/,/g,"").trim();if(!r)return null;let t=Number(r);return Number.isFinite(t)?Math.trunc(t):null}(t.to_parcel_quantity),_=d(t.loaded_timestamp),m=d(t.departure_timestamp);return{rowKey:function(e,r,t,o,a){let s=r?r.toISOString().slice(0,10):"",i=o?o.toISOString():"",u=[s,e,t||"",i].filter(Boolean).join("|");if(u)return u;let l=a?JSON.stringify(a):e;return(0,n.createHash)("sha256").update(l).digest("hex")}(o,u,l,_,e),dispatchDate:u,origin:t.origin||null,toDestStationName:t.to_dest_station_name||null,tripNumber:o,toNumber:l,toParcelQuantity:p,loadedTimestamp:_,operatorRaw:a||null,operatorOpsId:s,operatorName:i,departureTimestamp:m,truckSize:t.truck_size||null,vehicleNumber:t.vehicle_number||null,driverName:t.driver_name||null,rawPayload:e}}async function m(){let e;let r=process.env.GOOGLE_SHEETS_ID,t=process.env.GOOGLE_SHEETS_API_KEY,o=process.env.GOOGLE_SHEETS_RANGE||"dispatch_sync!A:L";if(!r||!t)throw Error("GOOGLE_SHEETS_ID and GOOGLE_SHEETS_API_KEY are required");let a=new URL(`https://sheets.googleapis.com/v4/spreadsheets/${r}/values/${encodeURIComponent(o)}`);a.searchParams.set("key",t),a.searchParams.set("valueRenderOption","FORMATTED_VALUE"),a.searchParams.set("dateTimeRenderOption","FORMATTED_STRING");let n=new AbortController,s=setTimeout(()=>n.abort(),15e3);try{e=await fetch(a.toString(),{signal:n.signal})}catch(e){if(e instanceof Error&&"AbortError"===e.name)throw Error("Google Sheets request timed out");throw e}finally{clearTimeout(s)}if(!e.ok)throw Error(`Google Sheets fetch failed: ${e.status}`);let i=await e.json(),u=Array.isArray(i.values)?i.values:[];if(0===u.length)return[];let[l,...p]=u,d=(Array.isArray(l)?l:[]).map(e=>c(e));return 0===d.length?[]:p.filter(e=>Array.isArray(e)).map(e=>{let r={};return d.forEach((t,o)=>{t&&(r[t]=e[o])}),r})}async function h(e){for(let r=0;r<e.length;r+=500){let t=e.slice(r,r+500),o=[];t.forEach(e=>{o.push(e.rowKey,e.dispatchDate??null,e.origin??null,e.toDestStationName??null,e.tripNumber,e.toNumber??null,e.toParcelQuantity??null,e.loadedTimestamp??null,e.operatorRaw??null,e.operatorOpsId??null,e.operatorName??null,e.departureTimestamp??null,e.truckSize??null,e.vehicleNumber??null,e.driverName??null,JSON.stringify(e.rawPayload))}),await (0,s.I)(function(e){let r=E.join(", "),t=Array.from({length:e},(e,r)=>{let t=r*E.length,o=E.map((e,r)=>`$${t+r+1}`).join(", ");return`(${o}, NOW())`}).join(", ");return`
    INSERT INTO dispatch_google_sheet_rows
    (${r}, updated_at)
    VALUES ${t}
    ON CONFLICT (row_key) DO UPDATE SET
      dispatch_date = EXCLUDED.dispatch_date,
      origin = EXCLUDED.origin,
      to_dest_station_name = EXCLUDED.to_dest_station_name,
      trip_number = EXCLUDED.trip_number,
      to_number = EXCLUDED.to_number,
      to_parcel_quantity = EXCLUDED.to_parcel_quantity,
      loaded_timestamp = EXCLUDED.loaded_timestamp,
      operator_raw = EXCLUDED.operator_raw,
      operator_ops_id = COALESCE(EXCLUDED.operator_ops_id, dispatch_google_sheet_rows.operator_ops_id),
      operator_name = COALESCE(EXCLUDED.operator_name, dispatch_google_sheet_rows.operator_name),
      departure_timestamp = EXCLUDED.departure_timestamp,
      truck_size = EXCLUDED.truck_size,
      vehicle_number = EXCLUDED.vehicle_number,
      driver_name = EXCLUDED.driver_name,
      raw_payload = EXCLUDED.raw_payload,
      updated_at = NOW();
  `}(t.length),o)}}let f=(0,i.g)("/api/sync/google-sheets",async e=>{if("false"===process.env.FEATURE_GOOGLE_SHEETS_SYNC)return a.NextResponse.json({error:"Google Sheets sync is disabled"},{status:403});let r=process.env.WEBHOOK_SECRET,{searchParams:t}=new URL(e.url),o=e.headers.get("x-webhook-secret")||t.get("secret");if(r&&o!==r)return a.NextResponse.json({error:"Unauthorized"},{status:401});let n=await (0,u.Y)(e,y);if(n.errorResponse)return n.errorResponse;let s=n.data,i=function(e){if(!e||!Array.isArray(e.rows))return null;let r=e.rows;if(0===r.length)return[];if(Array.isArray(r[0])){let t=(Array.isArray(e.headers)?e.headers:r[0]).map(e=>c(e));return(Array.isArray(e.headers)?r:r.slice(1)).filter(e=>Array.isArray(e)).map(e=>{let r={};return t.forEach((t,o)=>{t&&(r[t]=e[o])}),r})}return"object"==typeof r[0]&&null!==r[0]?r:[]}(s);if(!i)try{i=await m()}catch(e){return a.NextResponse.json({error:e instanceof Error?e.message:"Failed to fetch sheet data"},{status:500})}let l=i.map(_).filter(e=>!!e);return 0===l.length?a.NextResponse.json({synced:0,ignored:i.length}):(await h(l),a.NextResponse.json({synced:l.length,ignored:i.length-l.length}))});o()}catch(e){o(e)}})},75748:(e,r,t)=>{t.a(e,async(e,o)=>{try{t.d(r,{I:()=>u,Z:()=>l});var a=t(8678),n=t(11958),s=t(43895),i=e([a]);a=(i.then?(await i)():i)[0];let p=process.env.DATABASE_URL;if(!p)throw Error("DATABASE_URL is not set");let c="true"===process.env.DATABASE_SSL,d=globalThis.__pgPool||new a.Pool({connectionString:p,ssl:c?{rejectUnauthorized:!1}:void 0});async function u(e,r){let t=Date.now(),o=(0,n.T)(),a=o?.route??"unknown",i=o?.requestId;try{let o=await d.query(e,r),n=o.rowCount,u="number"==typeof n?n:o.rows?.length??0,l=Date.now()-t;return s.k.info({type:"db.query",route:a,requestId:i,ms:l,rows:u},"db.query"),o}catch(o){let e=Date.now()-t,r=o instanceof Error?o.message:String(o);throw s.k.error({type:"db.query.error",route:a,requestId:i,ms:e,error:r},"db.query.error"),o}}async function l(e){let r=await d.connect(),t={query:async(e,t)=>{let o=Date.now(),a=(0,n.T)(),i=a?.route??"unknown",u=a?.requestId;try{let a=await r.query(e,t),n=a.rowCount,l="number"==typeof n?n:a.rows?.length??0,p=Date.now()-o;return s.k.info({type:"db.query",route:i,requestId:u,ms:p,rows:l},"db.query"),a}catch(t){let e=Date.now()-o,r=t instanceof Error?t.message:String(t);throw s.k.error({type:"db.query.error",route:i,requestId:u,ms:e,error:r},"db.query.error"),t}},release:()=>r.release()};try{await t.query("BEGIN");let r=await e(t);return await t.query("COMMIT"),r}catch(e){try{await t.query("ROLLBACK")}catch{}throw e}finally{r.release()}}globalThis.__pgPool||(globalThis.__pgPool=d),o()}catch(e){o(e)}})},43895:(e,r,t)=>{t.d(r,{k:()=>s});var o=t(99557),a=t.n(o);let n=process.env.LOG_LEVEL||"info",s=a()({level:n,base:{service:"Outbound Internal Tool"},timestamp:a().stdTimeFunctions.isoTime})},11958:(e,r,t)=>{t.d(r,{T:()=>p,g:()=>c});var o=t(92761),a=t(6005),n=t(87070),s=t(43895),i=t(27231);let u=!!(process.env.SENTRY_DSN||process.env.NEXT_PUBLIC_SENTRY_DSN),l=new o.AsyncLocalStorage;function p(){return l.getStore()}function c(e,r){return async function(t,o){let p=Date.now(),c=t.method,d=t.headers.get("x-request-id")||(0,a.randomUUID)();return l.run({route:e,requestId:d},async()=>{let a=500;try{let e=await r(t,o);return a=e.status,e.headers.set("x-request-id",d),e}catch(t){var l;s.k.error({err:t,route:e,method:c,requestId:d},"api.error"),l={route:e,method:c,requestId:d},u&&i.$e(e=>{l?.requestId&&e.setTag("request_id",l.requestId),l?.route&&e.setTag("route",l.route),l?.method&&e.setTag("method",l.method),i.Tb(t)});let r=n.NextResponse.json({error:"Internal server error",request_id:d},{status:500});return r.headers.set("x-request-id",d),a=500,r}finally{let r=Date.now()-p;s.k.info({type:"api.request",route:e,method:c,status:a,ms:r,requestId:d},"api.request")}})}}},84235:(e,r,t)=>{t.d(r,{Y:()=>a});var o=t(87070);async function a(e,r){let t=await e.json().catch(()=>void 0),a=r.safeParse(t??{});if(!a.success){let e=a.error.flatten(),r=a.error.errors[0]?.message||"Invalid request";return{errorResponse:o.NextResponse.json({error:r,details:e},{status:400})}}return{data:a.data}}}};var r=require("../../../../webpack-runtime.js");r.C(e);var t=e=>r(r.s=e),o=r.X(0,[9276,7936,1067],()=>t(18834));module.exports=o})();