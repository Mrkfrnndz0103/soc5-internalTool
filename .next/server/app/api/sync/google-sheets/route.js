"use strict";(()=>{var e={};e.id=4138,e.ids=[4138],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},84770:e=>{e.exports=require("crypto")},8678:e=>{e.exports=import("pg")},92761:e=>{e.exports=require("node:async_hooks")},18834:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{originalPathname:()=>m,patchFetch:()=>u,requestAsyncStorage:()=>c,routeModule:()=>p,serverHooks:()=>d,staticGenerationAsyncStorage:()=>_});var o=r(49303),n=r(88716),s=r(60670),i=r(21187),l=e([i]);i=(l.then?(await l)():l)[0];let p=new o.AppRouteRouteModule({definition:{kind:n.x.APP_ROUTE,page:"/api/sync/google-sheets/route",pathname:"/api/sync/google-sheets",filename:"route",bundlePath:"app/api/sync/google-sheets/route"},resolvedPagePath:"C:\\Users\\phlspxuser\\Documents\\Mrkcde\\Ongoing\\soc5-internalTool\\src\\app\\api\\sync\\google-sheets\\route.ts",nextConfigOutput:"",userland:i}),{requestAsyncStorage:c,staticGenerationAsyncStorage:_,serverHooks:d}=p,m="/api/sync/google-sheets/route";function u(){return(0,s.patchFetch)({serverHooks:d,staticGenerationAsyncStorage:_})}a()}catch(e){a(e)}})},21187:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.r(t),r.d(t,{POST:()=>g});var o=r(87070),n=r(84770),s=r(75748),i=r(69026),l=e([s]);s=(l.then?(await l)():l)[0];let m={dispatchdate:"dispatch_date",origin:"origin",todeststationname:"to_dest_station_name",tripnumber:"trip_number",tripno:"trip_number",tonumber:"to_number",toparcelquantity:"to_parcel_quantity",loadedtimestamp:"loaded_timestamp",operator:"operator",departuretimestamp:"departure_timestamp",trucksize:"truck_size",vehiclenumber:"vehicle_number",drivername:"driver_name"},h=`
  INSERT INTO dispatch_google_sheet_rows
  (row_key, dispatch_date, origin, to_dest_station_name, trip_number, to_number, to_parcel_quantity, loaded_timestamp, operator_raw, operator_ops_id, operator_name, departure_timestamp, truck_size, vehicle_number, driver_name, raw_payload, updated_at)
  VALUES ($1, $2, $3, $4, $5, $6, $7, $8, $9, $10, $11, $12, $13, $14, $15, $16, NOW())
  ON CONFLICT (row_key) DO UPDATE SET
    dispatch_date = EXCLUDED.dispatch_date,
    origin = EXCLUDED.origin,
    to_dest_station_name = EXCLUDED.to_dest_station_name,
    trip_number = EXCLUDED.trip_number,
    to_number = EXCLUDED.to_number,
    to_parcel_quantity = EXCLUDED.to_parcel_quantity,
    loaded_timestamp = EXCLUDED.loaded_timestamp,
    operator_raw = EXCLUDED.operator_raw,
    operator_ops_id = COALESCE(EXCLUDED.operator_ops_id, dispatch_google_sheet_rows.operator_ops_id),
    operator_name = COALESCE(EXCLUDED.operator_name, dispatch_google_sheet_rows.operator_name),
    departure_timestamp = EXCLUDED.departure_timestamp,
    truck_size = EXCLUDED.truck_size,
    vehicle_number = EXCLUDED.vehicle_number,
    driver_name = EXCLUDED.driver_name,
    raw_payload = EXCLUDED.raw_payload,
    updated_at = NOW();
`;function u(e){return null==e?"":String(e).trim()}function p(e){if(!e)return null;let t=e.trim();if(!t)return null;if(/^\d+(\.\d+)?$/.test(t)){let e=Number(t);if(Number.isFinite(e)){let t=new Date((e-25569)*864e5);if(!Number.isNaN(t.getTime()))return t}}let r=new Date(t);return Number.isNaN(r.getTime())?null:r}function c(e){let t={};Object.entries(e).forEach(([e,r])=>{let a=e.toLowerCase().replace(/[^a-z0-9]/g,"");a&&(t[a]=u(r))});let r={};Object.entries(t).forEach(([e,t])=>{let a=m[e];a&&(r[a]=t)});let a=r.trip_number?.toUpperCase();if(!a)return null;let o=r.operator||"",s=null,i=null;if(o){let e=o.match(/\[([^\]]+)\]\s*(.+)/);e?(s=e[1].trim(),i=e[2].trim()||null):i=o}let l=p(r.dispatch_date),c=r.to_number||null,_=function(e){if(!e)return null;let t=e.replace(/,/g,"").trim();if(!t)return null;let r=Number(t);return Number.isFinite(r)?Math.trunc(r):null}(r.to_parcel_quantity),d=p(r.loaded_timestamp),h=p(r.departure_timestamp);return{rowKey:function(e,t,r,a,o){let s=t?t.toISOString().slice(0,10):"",i=a?a.toISOString():"",l=[s,e,r||"",i].filter(Boolean).join("|");if(l)return l;let u=o?JSON.stringify(o):e;return(0,n.createHash)("sha256").update(u).digest("hex")}(a,l,c,d,e),dispatchDate:l,origin:r.origin||null,toDestStationName:r.to_dest_station_name||null,tripNumber:a,toNumber:c,toParcelQuantity:_,loadedTimestamp:d,operatorRaw:o||null,operatorOpsId:s,operatorName:i,departureTimestamp:h,truckSize:r.truck_size||null,vehicleNumber:r.vehicle_number||null,driverName:r.driver_name||null,rawPayload:e}}async function _(){let e=process.env.GOOGLE_SHEETS_ID,t=process.env.GOOGLE_SHEETS_API_KEY,r=process.env.GOOGLE_SHEETS_RANGE||"dispatch_sync!A:L";if(!e||!t)throw Error("GOOGLE_SHEETS_ID and GOOGLE_SHEETS_API_KEY are required");let a=new URL(`https://sheets.googleapis.com/v4/spreadsheets/${e}/values/${encodeURIComponent(r)}`);a.searchParams.set("key",t),a.searchParams.set("valueRenderOption","FORMATTED_VALUE"),a.searchParams.set("dateTimeRenderOption","FORMATTED_STRING");let o=await fetch(a.toString());if(!o.ok)throw Error(`Google Sheets fetch failed: ${o.status}`);let n=await o.json(),s=Array.isArray(n.values)?n.values:[];if(0===s.length)return[];let[i,...l]=s,p=(Array.isArray(i)?i:[]).map(e=>u(e));return 0===p.length?[]:l.filter(e=>Array.isArray(e)).map(e=>{let t={};return p.forEach((r,a)=>{r&&(t[r]=e[a])}),t})}async function d(e){for(let t of e)await (0,s.I)(h,[t.rowKey,t.dispatchDate,t.origin,t.toDestStationName,t.tripNumber,t.toNumber,t.toParcelQuantity,t.loadedTimestamp,t.operatorRaw,t.operatorOpsId,t.operatorName,t.departureTimestamp,t.truckSize,t.vehicleNumber,t.driverName,JSON.stringify(t.rawPayload)])}let g=(0,i.g)("/api/sync/google-sheets",async e=>{if("false"===process.env.FEATURE_GOOGLE_SHEETS_SYNC)return o.NextResponse.json({error:"Google Sheets sync is disabled"},{status:403});let t=process.env.WEBHOOK_SECRET,{searchParams:r}=new URL(e.url),a=e.headers.get("x-webhook-secret")||r.get("secret");if(t&&a!==t)return o.NextResponse.json({error:"Unauthorized"},{status:401});let n=await e.json().catch(()=>({})),s=function(e){if(!e||!Array.isArray(e.rows))return null;let t=e.rows;if(0===t.length)return[];if(Array.isArray(t[0])){let r=(Array.isArray(e.headers)?e.headers:t[0]).map(e=>u(e));return(Array.isArray(e.headers)?t:t.slice(1)).filter(e=>Array.isArray(e)).map(e=>{let t={};return r.forEach((r,a)=>{r&&(t[r]=e[a])}),t})}return"object"==typeof t[0]&&null!==t[0]?t:[]}(n);if(!s)try{s=await _()}catch(e){return o.NextResponse.json({error:e instanceof Error?e.message:"Failed to fetch sheet data"},{status:500})}let i=s.map(c).filter(e=>!!e);return 0===i.length?o.NextResponse.json({synced:0,ignored:s.length}):(await d(i),o.NextResponse.json({synced:i.length,ignored:s.length-i.length}))});a()}catch(e){a(e)}})},75748:(e,t,r)=>{r.a(e,async(e,a)=>{try{r.d(t,{I:()=>i});var o=r(8678),n=r(69026),s=e([o]);o=(s.then?(await s)():s)[0];let l=process.env.DATABASE_URL;if(!l)throw Error("DATABASE_URL is not set");let u="true"===process.env.DATABASE_SSL,p=globalThis.__pgPool||new o.Pool({connectionString:l,ssl:u?{rejectUnauthorized:!1}:void 0});async function i(e,t){let r=Date.now(),a=n.T()?.route??"unknown";try{let o=await p.query(e,t),n=o.rowCount,s="number"==typeof n?n:o.rows?.length??0,i=Date.now()-r;return console.log(JSON.stringify({type:"db.query",route:a,ms:i,rows:s})),o}catch(o){let e=Date.now()-r,t=o instanceof Error?o.message:String(o);throw console.error(JSON.stringify({type:"db.query.error",route:a,ms:e,error:t})),o}}globalThis.__pgPool||(globalThis.__pgPool=p),a()}catch(e){a(e)}})},69026:(e,t,r)=>{r.d(t,{T:()=>o,g:()=>n});let a=new(r(92761)).AsyncLocalStorage;function o(){return a.getStore()}function n(e,t){return async function(r,o){let n=Date.now(),s=r.method;return a.run({route:e},async()=>{let a=500;try{let e=await t(r,o);return a=e.status,e}finally{console.log(JSON.stringify({type:"api.request",route:e,method:s,status:a,ms:Date.now()-n}))}})}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),a=t.X(0,[9276,5972],()=>r(18834));module.exports=a})();