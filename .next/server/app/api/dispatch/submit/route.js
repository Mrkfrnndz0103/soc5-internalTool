"use strict";(()=>{var e={};e.id=6015,e.ids=[6015],e.modules={72934:e=>{e.exports=require("next/dist/client/components/action-async-storage.external.js")},54580:e=>{e.exports=require("next/dist/client/components/request-async-storage.external.js")},45869:e=>{e.exports=require("next/dist/client/components/static-generation-async-storage.external.js")},20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},85807:e=>{e.exports=require("module")},55315:e=>{e.exports=require("path")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},6162:e=>{e.exports=require("worker_threads")},8678:e=>{e.exports=import("pg")},92761:e=>{e.exports=require("node:async_hooks")},6005:e=>{e.exports=require("node:crypto")},65714:e=>{e.exports=require("node:diagnostics_channel")},15673:e=>{e.exports=require("node:events")},70612:e=>{e.exports=require("node:os")},49411:e=>{e.exports=require("node:path")},86802:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{originalPathname:()=>m,patchFetch:()=>d,requestAsyncStorage:()=>p,routeModule:()=>l,serverHooks:()=>_,staticGenerationAsyncStorage:()=>c});var i=r(49303),a=r(88716),o=r(60670),n=r(25780),u=e([n]);n=(u.then?(await u)():u)[0];let l=new i.AppRouteRouteModule({definition:{kind:a.x.APP_ROUTE,page:"/api/dispatch/submit/route",pathname:"/api/dispatch/submit",filename:"route",bundlePath:"app/api/dispatch/submit/route"},resolvedPagePath:"C:\\Users\\phlspxuser\\Documents\\Mrkcde\\Ongoing\\soc5-internalTool\\src\\app\\api\\dispatch\\submit\\route.ts",nextConfigOutput:"",userland:n}),{requestAsyncStorage:p,staticGenerationAsyncStorage:c,serverHooks:_}=l,m="/api/dispatch/submit/route";function d(){return(0,o.patchFetch)({serverHooks:_,staticGenerationAsyncStorage:c})}s()}catch(e){s(e)}})},25780:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.r(t),r.d(t,{POST:()=>b});var i=r(87070),a=r(75748),o=r(95456),n=r(11958),u=r(76097),d=r(84235),l=r(21067),p=e([a,o,u]);[a,o,u]=p.then?(await p)():p;let f=/^LT[A-Z0-9]+$/,x=/^[A-Z0-9\s-]+$/,h=l.Ry({rows:l.IX(l.Yj(),{required_error:"rows are required"}).min(1,"rows are required").max(10,"rows must be <= 10"),submitted_by_ops_id:l.Z_({required_error:"submitted_by_ops_id is required"}).trim().min(1,"submitted_by_ops_id is required")}).strict();function c(e,t){for(let r of t)if(void 0!==e[r]&&null!==e[r]&&""!==e[r])return e[r];return null}function _(e){return null==e?"":String(e).trim()}function m(e){if(null==e||""===e)return null;let t=new Date(e);return Number.isNaN(t.getTime())?null:t}let b=(0,n.g)("/api/dispatch/submit",async e=>{let t=await (0,o.Gg)();if(!t)return i.NextResponse.json({error:"Unauthorized"},{status:401});let r=await (0,u.l)(t.sessionId);if(!r.allowed)return i.NextResponse.json({error:"Too many requests"},{status:429,headers:{"Retry-After":String(r.retryAfterSeconds)}});let s=await (0,d.Y)(e,h);if(s.errorResponse)return s.errorResponse;let n=s.data.rows,l=s.data.submitted_by_ops_id,p=[],b=[];if(n.forEach((e,t)=>{let r={},s="string"==typeof e?.id?e.id:void 0,i=_(c(e,["cluster_name","clusterName"]));i||(r.cluster_name="cluster_name is required");let a=_(c(e,["station_name","station","stationName"]));a||(r.station_name="station_name is required");let o=_(c(e,["region"]));o||(r.region="region is required"),_(c(e,["count_of_to","countTO","countTo"]))||(r.count_of_to="count_of_to is required");let n=c(e,["total_oid_loaded","totalOIDLoaded","totalOidLoaded"]),u=function(e){if(null==e||""===e)return null;let t="string"==typeof e?e.replace(/,/g,"").trim():e,r="number"==typeof t?t:Number(t);return Number.isFinite(r)&&Number.isInteger(r)?r:null}(n);null===n||""===n||void 0===n?r.total_oid_loaded="total_oid_loaded is required":(null===u||u<0)&&(r.total_oid_loaded="total_oid_loaded must be an integer >= 0"),_(c(e,["dock_number","dockNumber"]))||(r.dock_number="dock_number is required");let d=c(e,["dock_confirmed","dockConfirmed"]);!function(e){if(!0===e)return!0;if(!1===e)return!1;if(1===e||"1"===e)return!0;if(0===e||"0"===e)return!1;if("string"==typeof e){let t=e.trim().toLowerCase();if("true"===t)return!0}return!1}(d)&&(r.dock_confirmed="dock_confirmed must be true"),_(c(e,["assigned_ops_id","assignedPIC","assignedOpsId"]))||(r.assigned_ops_id="assigned_ops_id is required");let l=c(e,["actual_docked_time","actualDockedTime"]),h=m(l);h||(r.actual_docked_time="actual_docked_time is required");let g=c(e,["actual_depart_time","actualDepartTime"]),N=m(g);g&&!N&&(r.actual_depart_time="actual_depart_time must be a valid datetime"),h&&N&&N<h&&(r.actual_depart_time="actual_depart_time must be >= actual_docked_time");let q=_(c(e,["status"]))||"Pending",y=_(c(e,["lh_trip_number","lh_trip","lHTripNumber"])),T=y?y.toUpperCase():"";T&&!f.test(T)&&(r.lh_trip_number="lh_trip_number must match ^LT[A-Z0-9]+$");let w=_(c(e,["plate_number","plateNumber"])),k=w?w.toUpperCase():"";k&&!x.test(k)&&(r.plate_number="plate_number must match ^[A-Z0-9\\s-]+$");let E=_(c(e,["processor_name","processorName"]));if(Object.keys(r).length>0){b.push({rowIndex:t,id:s,errors:r});return}p.push({clusterName:i,stationName:a,region:o,status:q,lhTrip:T||null,dockedTime:h,departTime:N||null,processor:E||null,plate:k||null})}),b.length>0){let e=b.map(e=>({rowIndex:e.rowIndex,status:"error",errors:e.errors}));return i.NextResponse.json({ok:!1,error:"Validation failed",submitted:0,failed:b.length,errors_count:b.length,results:e})}let g=[],N=p.map((e,t)=>{let r=10*t;g.push(e.clusterName,e.stationName,e.region,e.status,e.lhTrip,e.dockedTime,e.departTime,e.processor,e.plate,l);let s=Array.from({length:10},(e,t)=>`$${r+t+1}`).join(", ");return`(${s}, NOW(), NOW())`}).join(", ");await (0,a.Z)(async e=>{await e.query(`INSERT INTO dispatch_reports
       (cluster_name, station_name, region, status, lh_trip_number, actual_docked_time, actual_depart_time, processor_name, plate_number, submitted_by_ops_id, created_at, status_updated_at)
       VALUES ${N}`,g)});let q=p.map((e,t)=>({rowIndex:t,status:"created"}));return i.NextResponse.json({ok:!0,submitted:p.length,failed:0,created_count:p.length,errors_count:0,results:q})});s()}catch(e){s(e)}})},76097:(e,t,r)=>{r.a(e,async(e,s)=>{try{r.d(t,{l:()=>n});var i=r(75748),a=e([i]);function o(e,t){if(!e)return t;let r=Number(e);return!Number.isFinite(r)||r<=0?t:r}i=(a.then?(await a)():a)[0];let u=o(process.env.RATE_LIMIT_WINDOW_MS,6e4),d=o(process.env.RATE_LIMIT_MAX_REQUESTS,60);async function n(e,t){let r=t?.windowMs??u,s=t?.limit??d,a=`${Math.max(1,Math.floor(r/1e3))} seconds`,o=(await (0,i.I)(`INSERT INTO session_rate_limits (session_id, count, expires_at)
     VALUES ($1, 1, NOW() + $2::interval)
     ON CONFLICT (session_id)
     DO UPDATE SET
       count = CASE WHEN session_rate_limits.expires_at < NOW() THEN 1 ELSE session_rate_limits.count + 1 END,
       expires_at = CASE WHEN session_rate_limits.expires_at < NOW() THEN NOW() + $2::interval ELSE session_rate_limits.expires_at END
     RETURNING count, expires_at`,[e,a])).rows[0];if((o?.count??s+1)>s){let e=o?.expires_at?new Date(o.expires_at).getTime():Date.now()+r,t=Math.max(1,Math.ceil((e-Date.now())/1e3));return{allowed:!1,retryAfterSeconds:t,limit:s}}return{allowed:!0,retryAfterSeconds:0,limit:s}}s()}catch(e){s(e)}})},84235:(e,t,r)=>{r.d(t,{Y:()=>i});var s=r(87070);async function i(e,t){let r=await e.json().catch(()=>void 0),i=t.safeParse(r??{});if(!i.success){let e=i.error.flatten(),t=i.error.errors[0]?.message||"Invalid request";return{errorResponse:s.NextResponse.json({error:t,details:e},{status:400})}}return{data:i.data}}}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),s=t.X(0,[9276,7936,1067,5456],()=>r(86802));module.exports=s})();